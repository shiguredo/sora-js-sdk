<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>updown test</title>
    </head>
    <body>
        <div class="container">
            <h1>updown test</h1>
            <button id="start">start</button>
            <div>
                <h2>up</h2>
                <video id="local-video" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
            </div>
            <div>
                <h2>down</h2>
                <video id="remote-video" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
            </div>
        </div>

        <script src="./sora.js"></script>
        <script type="text/javascript">
var RTCPeerConnection = window.RTCPeerConnection;
var RTCSessionDescription = window.RTCSessionDescription;
var upstreamPc, downstreamPc;
var sora = new Sora("ws://127.0.0.1:5000/signaling");
var channelId = "Sora";
var upstreamToken = "";
var downstreamToken = "";

document.querySelector("#start").addEventListener("click", function() {
  upstream();
  downstream();
});

function upstream() {
  var connection = sora.connection();
  var offer, localStream;
  navigator.mediaDevices.getUserMedia({video: true})
    .then(stream => {
      localStream = stream;
      var params = {
        role: "upstream",
        channelId: channelId,
        accessToken: upstreamToken
      };
      return connection.connect(params)
    })
    .then(message => {
      offer = message;
      return RTCPeerConnection.generateCertificate({ name: "ECDSA", namedCurve: "P-256" })
    })
    .then(certificate => {
      upstreamPc = new RTCPeerConnection(offer.config);
      upstreamPc.addStream(localStream);
      return upstreamPc.setRemoteDescription(new RTCSessionDescription(offer));
    })
    .then(() => {
      return upstreamPc.createAnswer({});
    })
    .then(sessionDescription => {
      return upstreamPc.setLocalDescription(sessionDescription);
    })
    .then(() => {
      connection.answer(upstreamPc.localDescription.sdp);
      upstreamPc.onicecandidate = function(event) {
        if (event.candidate !== null) {
          connection.candidate(event.candidate);
        }
      };
      document.querySelector("#local-video").srcObject = localStream;
      return Promise.resolve();
    })
    .catch(e => {
      console.error(e);
    });
}

function downstream() {
  var connection = sora.connection();
  var offer;
  var params = {
    role: "downstream",
    channelId: channelId,
    accessToken: upstreamToken
  };
  connection.connect(params)
    .then(message => {
      offer = message;
      return RTCPeerConnection.generateCertificate({ name: "ECDSA", namedCurve: "P-256" })
    })
    .then(certificate => {
      downstreamPc = new RTCPeerConnection(offer.config);
      downstreamPc.onaddstream = function(event) {
        document.querySelector("#remote-video").srcObject = event.stream;
      };
      return downstreamPc.setRemoteDescription(new RTCSessionDescription(offer));
    })
    .then(() => {
      return downstreamPc.createAnswer({});
    })
    .then(sessionDescription => {
      return downstreamPc.setLocalDescription(sessionDescription);
    })
    .then(() => {
      connection.answer(downstreamPc.localDescription.sdp);
      downstreamPc.onicecandidate = function(event) {
        if (event.candidate !== null) {
          connection.candidate(event.candidate);
        }
      };
      return Promise.resolve();
    })
    .catch(e => {
      console.error(e);
    });
}
    </script>
  </body>
</html>
