
/*!
 * sora-js-sdk
 * WebRTC SFU Sora JavaScript SDK
 * @version: 1.16.0-dev
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 */

(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global = global || self, global.Sora = factory());
}(this, function () { 'use strict';

  function trace(a,b,c){let d="";window.performance&&(d="["+(window.performance.now()/1e3).toFixed(3)+"]"),a&&(d=d+"["+a+"]"),isEdge()?console.log(d+" "+b+"\n",c):console.info(d+" "+b+"\n",c);}function browser(){const a=window.navigator.userAgent.toLocaleLowerCase();if(-1!==a.indexOf("edge"))return "edge";return -1!==a.indexOf("chrome")&&-1===a.indexOf("edge")?"chrome":-1!==a.indexOf("safari")&&-1===a.indexOf("chrome")?"safari":-1===a.indexOf("opera")?-1===a.indexOf("firefox")?void 0:"firefox":"opera"}function enabledSimulcast(a,b){if("VP9"===b.codec_type)return !1;if(("upstream"===a||"sendrecv"===a||"sendonly"===a)&&"firefox"===browser())return !1;if(("upstream"===a||"sendrecv"===a||"sendonly"===a)&&"safari"===browser())return !1;if(("downstream"===a||"recvonly"===a)&&"safari"===browser()){const a=window.navigator.appVersion.toLowerCase(),c=/version\/([\d.]+)/.exec(a);if(!c)return !1;const d=c.pop();return !!(12<parseFloat(d))||12==parseFloat(d)&&"H264"===b.codec_type}return !0}function isEdge(){return "edge"===browser()}function isSafari(){return "safari"===browser()}function createSignalingMessage(a,b,c,d,e){if("upstream"!==b&&"downstream"!==b&&"sendrecv"!==b&&"sendonly"!==b&&"recvonly"!==b)throw new Error("Unknown role type");if(null===c||void 0===c)throw new Error("channelId can not be null or undefined");const f={type:"connect",sora_client:`Sora JavaScript SDK ${"1.16.0-dev"}`,environment:window.navigator.userAgent,role:b,channel_id:c,sdp:a,audio:!0,video:!0};if(d&&(f.metadata=d),"multistream"in e&&!0===e.multistream&&(f.multistream=!0,"spotlight"in e&&(f.spotlight=e.spotlight)),"simulcast"in e||"simulcastQuality"in e){"simulcast"in e&&!0===e.simulcast&&(f.simulcast=!0);"simulcastQuality"in e&&0<=["low","middle","high"].indexOf(e.simulcastQuality)&&(f.simulcast={quality:e.simulcastQuality});}"clientId"in e&&e.clientId&&(f.client_id=e.clientId);const g=["audioCodecType","audioBitRate"],h=["audioOpusParamsChannels","audioOpusParamsClockRate","audioOpusParamsMaxplaybackrate","audioOpusParamsStereo","audioOpusParamsSpropStereo","audioOpusParamsMinptime","audioOpusParamsPtime","audioOpusParamsUseinbandfec","audioOpusParamsUsedtx"],i=["videoCodecType","videoBitRate"],j=Object.assign({},e);Object.keys(j).forEach(a=>{"audio"===a&&"boolean"==typeof j[a]||"video"===a&&"boolean"==typeof j[a]||0<=g.indexOf(a)&&null!==j[a]||0<=h.indexOf(a)&&null!==j[a]||0<=i.indexOf(a)&&null!==j[a]||delete j[a];}),"audio"in j&&(f.audio=j.audio);const k=Object.keys(j).some(a=>0<=g.indexOf(a));f.audio&&k&&(f.audio={},"audioCodecType"in j&&(f.audio.codec_type=j.audioCodecType),"audioBitRate"in j&&(f.audio.bit_rate=j.audioBitRate));const l=Object.keys(j).some(a=>0<=h.indexOf(a));f.audio&&l&&("object"!=typeof f.audio&&(f.audio={}),f.audio.opus_params={},"audioOpusParamsChannels"in j&&(f.audio.opus_params.channels=j.audioOpusParamsChannels),"audioOpusParamsClockRate"in j&&(f.audio.opus_params.clock_rate=j.audioOpusParamsClockRate),"audioOpusParamsMaxplaybackrate"in j&&(f.audio.opus_params.maxplaybackrate=j.audioOpusParamsMaxplaybackrate),"audioOpusParamsStereo"in j&&(f.audio.opus_params.stereo=j.audioOpusParamsStereo),"audioOpusParamsSpropStereo"in j&&(f.audio.opus_params.sprop_stereo=j.audioOpusParamsSpropStereo),"audioOpusParamsMinptime"in j&&(f.audio.opus_params.minptime=j.audioOpusParamsMinptime),"audioOpusParamsPtime"in j&&(f.audio.opus_params.ptime=j.audioOpusParamsPtime),"audioOpusParamsUseinbandfec"in j&&(f.audio.opus_params.useinbandfec=j.audioOpusParamsUseinbandfec),"audioOpusParamsUsedtx"in j&&(f.audio.opus_params.usedtx=j.audioOpusParamsUsedtx)),"video"in j&&(f.video=j.video);const m=Object.keys(j).some(a=>0<=i.indexOf(a));if(f.video&&m&&(f.video={},"videoCodecType"in j&&(f.video.codec_type=j.videoCodecType),"videoBitRate"in j&&(f.video.bit_rate=j.videoBitRate)),f.simulcast&&!enabledSimulcast(f.role,f.video))throw new Error("Simulcast can not be used with this browser");return f}

  class ConnectionBase{constructor(a,b,c,d,e,f){this.role=b,this.channelId=c,this.metadata=d,this.signalingUrl=a,this.options=e,this.constraints=null,this.debug=f,this.clientId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},push:function(){},addstream:function(){},removestream:function(){},notify:function(){},log:function(){},timeout:function(){}},this.authMetadata=null;}on(a,b){a in this._callbacks&&(this._callbacks[a]=b);}disconnect(){this.clientId=null,this.connectionId=null,this.authMetadata=null,this.remoteConnectionIds=[];const a=new Promise(a=>this.stream?(this.stream.getTracks().forEach(a=>{a.stop();}),this.stream=null,a()):a()),b=new Promise((a,b)=>{if(!this._ws)return a();this._ws.onclose=()=>{};let c=5;const d=setInterval(()=>this._ws?3===this._ws.readyState?(this._ws=null,clearInterval(d),a()):(--c,0>c)?(clearInterval(d),b("WebSocket Closing Error")):void 0:(clearInterval(d),b("WebSocket Closing Error")),1e3);this._ws.close();}),c=new Promise((a,b)=>{if(isSafari()&&this._pc)return this._pc.oniceconnectionstatechange=null,this._pc.close(),this._pc=null,a();if(!this._pc||"closed"===this._pc.signalingState)return a();let c=5;const d=setInterval(()=>this._pc?"closed"===this._pc.signalingState?(clearInterval(d),this._pc.oniceconnectionstatechange=null,this._pc=null,a()):(--c,0>c)?(clearInterval(d),b("PeerConnection Closing Error")):void 0:(clearInterval(d),b("PeerConnection Closing Error")),1e3);this._pc.close();});return Promise.all([a,b,c])}_signaling(a){return this._trace("CREATE OFFER SDP",a),new Promise((b,c)=>{const d=createSignalingMessage(a.sdp,this.role,this.channelId,this.metadata,this.options);null===this._ws&&(this._ws=new WebSocket(this.signalingUrl)),this._ws.onclose=a=>{c(a);},this._ws.onopen=()=>{this._trace("SIGNALING CONNECT MESSAGE",d),this._ws.send(JSON.stringify(d));},this._ws.onmessage=a=>{const c=JSON.parse(a.data);"offer"==c.type?(this.clientId=c.client_id,this.connectionId=c.connection_id,this._ws.onclose=a=>{this.disconnect().then(()=>{this._callbacks.disconnect(a);});},this._ws.onerror=null,"metadata"in c&&(this.authMetadata=c.metadata),this._trace("SIGNALING OFFER MESSAGE",c),this._trace("OFFER SDP",c.sdp),b(c)):"update"==c.type?(this._trace("UPDATE SDP",c.sdp),this._update(c)):"ping"==c.type?this._ws.send(JSON.stringify({type:"pong"})):"push"==c.type?this._callbacks.push(c):"notify"==c.type&&this._callbacks.notify(c);};})}_createOffer(){const a=new window.RTCPeerConnection({iceServers:[]});return isSafari()?(a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"}),a.createOffer().then(b=>(a.close(),Promise.resolve(b)))):a.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(b=>(a.close(),Promise.resolve(b)))}_connectPeerConnection(a){return a.config||(a.config={}),void 0===window.RTCPeerConnection.generateCertificate?(this._trace("PEER CONNECTION CONFIG",a.config),this._pc=new window.RTCPeerConnection(a.config,this.constraints),this._pc.oniceconnectionstatechange=()=>{this._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this._pc.iceConnectionState);},Promise.resolve(a)):window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(b=>(a.config.certificates=[b],this._trace("PEER CONNECTION CONFIG",a.config),this._pc=new window.RTCPeerConnection(a.config,this.constraints),this._pc.oniceconnectionstatechange=()=>{this._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this._pc.iceConnectionState);},a))}_setRemoteDescription(a){return this._pc.setRemoteDescription(new window.RTCSessionDescription({type:"offer",sdp:a.sdp})).then(()=>Promise.resolve(a))}_createAnswer(a){if(this.options.simulcast&&("upstream"===this.role||"sendrecv"===this.role||"sendonly"===this.role)&&a.encodings){const b=this._pc.getTransceivers().find(a=>{if(a.mid&&0<=a.mid.indexOf("video")&&null==a.currentDirection)return a});return b?this._setSenderParameters(b,a.encodings).then(()=>this._pc.createAnswer()).then(a=>this._pc.setLocalDescription(a)):Promise.reject("Simulcast Error")}return this._pc.createAnswer().then(a=>this._pc.setLocalDescription(a))}_setSenderParameters(a,b){const c=a.sender.getParameters();return c.encodings=b,a.sender.setParameters(c)}_sendAnswer(){return this._trace("ANSWER SDP",this._pc.localDescription.sdp),void this._ws.send(JSON.stringify({type:"answer",sdp:this._pc.localDescription.sdp}))}_sendUpdateAnswer(){return this._trace("ANSWER SDP",this._pc.localDescription.sdp),void this._ws.send(JSON.stringify({type:"update",sdp:this._pc.localDescription.sdp}))}_onIceCandidate(){return new Promise((a,b)=>{const c=setInterval(()=>{if(null===this._pc){clearInterval(c);const a=new Error;a.message="ICECANDIDATE TIMEOUT",b(a);}else this._pc&&"connected"===this._pc.iceConnectionState&&(clearInterval(c),a());},100);this._pc.onicecandidate=b=>{if(this._trace("ONICECANDIDATE ICEGATHERINGSTATE",this._pc.iceGatheringState),null===b.candidate)clearInterval(c),a();else{const a=b.candidate.toJSON();a.type="candidate",this._trace("ONICECANDIDATE CANDIDATE MESSAGE",a),this._ws.send(JSON.stringify(a));}};})}_sendStats(){if(this.options.stats){let a=5e3;0<this.options.statsInterval&&(a=1e3*this.options.statsInterval),setInterval(()=>{this._pc&&this._ws&&this._pc.getStats().then(a=>{if(!a)return;const b=[];a.forEach(a=>{b.push(a);}),this._ws.send(JSON.stringify({type:"stats",stats:b}));});},a);}}_update(a){return this._setRemoteDescription(a).then(this._createAnswer.bind(this)).then(this._sendUpdateAnswer.bind(this))}_trace(a,b){this._callbacks.log(a,b);this.debug&&trace(this.clientId,a,b);}}

  class ConnectionPublisher extends ConnectionBase{connect(a){return this.options&&this.options.multistream?this._multiStream(a):this._singleStream(a)}_singleStream(a){return new Promise((b,c)=>{let d=null;this.options.timeout&&0<this.options.timeout&&(d=setTimeout(()=>{const a=new Error;a.message="CONNECTION TIMEOUT",this._callbacks.timeout(),this.disconnect(),c(a);},this.options.timeout)),this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(this._setRemoteDescription.bind(this)).then(b=>("undefined"==typeof this._pc.addStream?a.getTracks().forEach(b=>{this._pc.addTrack(b,a);}):this._pc.addStream(a),this.stream=a,Promise.resolve(b))).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(()=>{clearTimeout(d),this._sendStats(),b(this.stream);}).catch(a=>{c(a);});})}_multiStream(a){return new Promise((b,c)=>{let d=null;this.options.timeout&&0<parseInt(this.options.timeout)&&(d=setTimeout(()=>{const a=new Error;a.message="CONNECTION TIMEOUT",this._callbacks.timeout(),this.disconnect(),c(a);},this.options.timeout)),this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(b=>("undefined"==typeof this._pc.ontrack?this._pc.onaddstream=b=>{this.connectionId!==b.stream.id&&(this.remoteConnectionIds.push(a.id),this._callbacks.addstream(b));}:this._pc.ontrack=a=>{const b=a.streams[0];!b||"default"===b.id||b.id===this.connectionId||-1<this.remoteConnectionIds.indexOf(b.id)||(a.stream=b,this.remoteConnectionIds.push(b.id),this._callbacks.addstream(a));},this._pc.onremovestream=a=>{const b=this.remoteConnectionIds.indexOf(a.stream.id);-1<b&&delete this.remoteConnectionIds[b],this._callbacks.removestream(a);},this._setRemoteDescription(b))).then(b=>("undefined"==typeof this._pc.addStream?a.getTracks().forEach(b=>{this._pc.addTrack(b,a);}):this._pc.addStream(a),this.stream=a,Promise.resolve(b))).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(()=>{clearTimeout(d),this._sendStats(),b(this.stream);}).catch(a=>{c(a);});})}}

  class ConnectionSubscriber extends ConnectionBase{connect(){return this.options&&this.options.multistream?this._multiStream():this._singleStream()}_singleStream(){return new Promise((a,b)=>{let c=null;this.options.timeout&&0<parseInt(this.options.timeout)&&(c=setTimeout(()=>{const a=new Error;a.message="CONNECTION TIMEOUT",this._callbacks.timeout(),this.disconnect(),b(a);},this.options.timeout)),this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(a=>("undefined"==typeof this._pc.ontrack?this._pc.onaddstream=function(a){this.stream=a.stream,this.remoteConnectionIds.push(this.stream.id),this._callbacks.addstream(a);}.bind(this):this._pc.ontrack=function(a){this.stream=a.streams[0];const b=this.stream.id;"default"===b||-1<this.remoteConnectionIds.indexOf(b)||(a.stream=this.stream,this.remoteConnectionIds.push(b),this._callbacks.addstream(a));}.bind(this),this._setRemoteDescription(a))).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(()=>{clearTimeout(c),this._sendStats(),a(this.stream);}).catch(a=>{b(a);});})}_multiStream(){return new Promise((a,b)=>{let c=null;this.options.timeout&&0<parseInt(this.options.timeout)&&(c=setTimeout(()=>{const a=new Error;a.message="CONNECTION TIMEOUT",this._callbacks.timeout(),this.disconnect(),b(a);},this.options.timeout)),this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(a=>("undefined"==typeof this._pc.ontrack?this._pc.onaddstream=a=>{this.remoteConnectionIds.push(a.id),this._callbacks.addstream(a);}:this._pc.ontrack=a=>{const b=a.streams[0];"default"===b.id||b.id===this.connectionId||-1<this.remoteConnectionIds.indexOf(b.id)||(a.stream=b,this.remoteConnectionIds.push(b.id),this._callbacks.addstream(a));},this._pc.onremovestream=a=>{const b=this.remoteConnectionIds.indexOf(a.stream.id);-1<b&&delete this.remoteConnectionIds[b],this._callbacks.removestream(a);},this._setRemoteDescription(a))).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(()=>{clearTimeout(c),this._sendStats(),a();}).catch(a=>{b(a);});})}}

  var sora = {connection:function(a,b=!1){return new SoraConnection(a,b)},version:function(){return "1.16.0-dev"}};class SoraConnection{constructor(a,b=!1){this.signalingUrl=a,this.debug=b;}publisher(a,b,c={audio:!0,video:!0}){return new ConnectionPublisher(this.signalingUrl,"upstream",a,b,c,this.debug)}subscriber(a,b,c={audio:!0,video:!0}){return new ConnectionSubscriber(this.signalingUrl,"downstream",a,b,c,this.debug)}sendrecv(a,b,c={audio:!0,video:!0}){return new ConnectionPublisher(this.signalingUrl,"sendrecv",a,b,c,this.debug)}sendonly(a,b,c={audio:!0,video:!0}){return new ConnectionPublisher(this.signalingUrl,"sendonly",a,b,c,this.debug)}recvonly(a,b,c={audio:!0,video:!0}){return new ConnectionSubscriber(this.signalingUrl,"recvonly",a,b,c,this.debug)}}

  return sora;

}));
